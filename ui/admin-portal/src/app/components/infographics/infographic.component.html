<!--
  ~ Copyright (c) 2024 Talent Catalog.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under
  ~ the terms of the GNU Affero General Public License as published by the Free
  ~ Software Foundation, either version 3 of the License, or any later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT
  ~ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  ~ FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see https://www.gnu.org/licenses/.
  -->

<tc-alert *ngIf="error">
  {{error}}
</tc-alert>

<form [formGroup]="statsFilter">
  <div class="container-fluid">
    <tc-fieldset>
      <div class="row gy-4">
        <tc-field class="col-12 col-lg-3">
          <tc-label>List</tc-label>
          <!-- Disabled if saved search is entered -->
          <ng-select
            class="tc-select"
            id="savedList"
            [items]="lists"
            [closeOnSelect]="false"
            [searchable]="true"
            placeholder="Select or type..."
            bindLabel="name"
            [readonly]="savedSearch != null || this.listFromUrl == true"
            formControlName="savedList">
          </ng-select>
        </tc-field>
        <tc-field class="col-12 col-lg-3">
          <tc-label>Search</tc-label>
          <!-- Disabled if saved list is entered -->
          <ng-select
            class="tc-select"
            id="savedSearch"
            [items]="searches"
            [closeOnSelect]="false"
            [searchable]="true"
            placeholder="Select or type..."
            bindLabel="name"
            [readonly]="savedList != null  || this.listFromUrl == true"
            formControlName="savedSearch">
          </ng-select>
        </tc-field>
        <tc-field class="col-12 col-lg-3">
          <tc-label for="dateFrom">Date From</tc-label>
          <tc-date-picker id="dateFrom"
                          [control]="statsFilter.controls.dateFrom"
                          [allowFuture]="false"
                          [showHelpText]="false"
          ></tc-date-picker>
        </tc-field>
        <tc-field class="col-12 col-lg-3">
            <tc-label for="dateTo">Date To</tc-label>
            <tc-date-picker id="dateTo"
                            [control]="statsFilter.controls.dateTo"
                            [allowFuture]="false"
                            [showHelpText]="false"
            ></tc-date-picker>
        </tc-field>
      </div>

      <div class="row align-items-center flex-lg-fill">
        <tc-field class="col-12 col-lg-9">
          <tc-label class="form-label" for="selectStats">Select Stats to Run</tc-label>
          <ng-select
            class="tc-select"
            id="selectStats"
            [items]="statOptions"
            [closeOnSelect]="false"
            [clearSearchOnAdd]="true"
            [searchable]="true"
            placeholder="Select or type..."
            bindLabel="stringValue"
            bindValue="key"
            [multiple] = "true"
            [maxSelectedItems]="8"
            formControlName="selectedStats">
          </ng-select>
          <tc-description>Due to processing size, maximum 8 stats can be run at a time.</tc-description>
        </tc-field>
        <tc-field class="col-12 col-lg-3 mb-0">
          <tc-button (onClick)="submitStatsRequest()" [disabled]="selectedStats.length == 0">
            <i class="fas fa-calendar-alt"></i> Run Stats
          </tc-button>
        </tc-field>
      </div>
    </tc-fieldset>
  </div>
</form>

<tc-loading [loading]="loading" [type]="'page'"></tc-loading>

<ng-container *ngIf="!loading">
  <!--Loop through reports data, displaying each report-->
  <div *ngIf="statReports">

    <nav class="navbar sticky-top navbar-expand-md second-nav">
      <span class="navbar-brand">Stats for {{statsName}}</span>
        <ul class="navbar-nav ms-auto">
          <tc-dropdown [hasItems]="statReports?.length > 1">
            <tc-dropdown-button [type]="'solid'"
                                [disabled]="!(statReports?.length > 1)"
            >
              Go to Stat <i class="fa-solid fa-hand-point-down"></i>
            </tc-dropdown-button>
            <tc-dropdown-menu>
              <tc-dropdown-item *ngFor="let statReport of statReports; let i = index" (click)="scroll(i)">{{statReport.name}}</tc-dropdown-item>
            </tc-dropdown-menu>
          </tc-dropdown>

          <tc-button [type]="'outline'"
                     class="float-end ms-2"
                     [disabled]="!dataLoaded"
                     (onClick)="exportStats()"
          >
            Export <i class="fas fa-file-excel"></i>
          </tc-button>

        </ul>
    </nav>

    <ng-container *ngFor="let statReport of statReports; let i = index">
      <div [id]="i">
        <div class="row ">
          <div class="col-sm-4">
            <div class="section">
              <h6 class="mb-3">{{statReport.name}}</h6>
              <app-chart *ngIf="statReport.rows.length <= 15 || statReport.chartType == 'bar'"
                         [chartData]="statReport.rows" [chartType]="statReport.chartType"
                         [chartLegend]="statReport.chartType != 'bar'"
              ></app-chart>
              <p *ngIf="statReport.rows.length > 15 && statReport.chartType != 'bar'">
                {{statReport.rows.length}} different values.
                Too many to display here. See the exported data for details.
              </p>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</ng-container>


