<!--
  ~ Copyright (c) 2024 Talent Catalog.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under
  ~ the terms of the GNU Affero General Public License as published by the Free
  ~ Software Foundation, either version 3 of the License, or any later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT
  ~ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  ~ FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see https://www.gnu.org/licenses/.
  -->

<div *ngIf="candidateSource && showSourceDetails">
  <app-candidate-source
          [candidateSource]="candidateSource" [seeMore]="false" [showMore]="true"
          [showOpen]="true" [showDelete]="true" [showEdit]="true" [showCopy]="true"
          [showRunStats]="true" [showStarred]="true"
          (openSource)="onOpenSource()"
          (toggleStarred)="onToggleStarred($event)"
          (toggleWatch)="onToggleWatch($event)"
          (deleteSource)="onDeleteSource($event)"
          (editSource)="onEditSource($event)"
          (copySource)="onCopySource($event)"
          (selectColumns)="onSelectColumns()"
  ></app-candidate-source>
</div>
<tc-alert *ngIf="error" type="danger">{{error}}</tc-alert>

<div *ngIf="results">
  <div *ngIf="timestamp" class="d-flex justify-content-between align-items-center my-3">
    <tc-button (onClick)="onRefreshRequest()">
      Refresh <i class="fas fa-sync" title="Refresh data"></i>
    </tc-button>
    <div class="small text-muted">
      Timestamp {{timestamp | date: 'customDateTime'}}
    </div>
  </div>

  <div class="table-responsive">
    <tc-table [results]="results"
              [loading]="searching"
              [(pageNumber)]="pageNumber"
              (pageChange)="onPageChange()"
              [paginationPosition]="'bottom'"
              [hover]="true"
              [striped]="false"
              [clickableRows]="false"
    >

      <thead class="">
      <tr>
        <th class="candidate-number-row sortable-column-header"
            (click)="toggleSort('id')"
        >
          <app-sorted-by [column]="'id'"
                         [sortColumn]="sortField"
                         [sortDirection]="sortDirection"
          ></app-sorted-by>
          #
        </th>
        <th *ngFor="let field of selectedFields">
          <div *ngIf="field.sortable; else nonSortableFields"
               (click)="toggleSort(field.fieldPath)"
               class="sortable-column-header"
          >
            <app-sorted-by [column]="field.fieldPath"
                           [sortColumn]="sortField"
                           [sortDirection]="sortDirection"
            ></app-sorted-by>
            {{field.displayName}}
          </div>
          <ng-template #nonSortableFields>
            {{field.displayName}}
          </ng-template>
        </th>
      </tr>
      </thead>

      <tbody>

      <tr *ngFor="let candidate of results?.content">
        <td>
          <div  class="d-flex align-items-center gap-1">
          <a class="fw-bold" [routerLink]="['/candidate',candidate.candidateNumber]">
            {{candidate.candidateNumber}}
          </a>
          <a target="_blank" [routerLink]="['/candidate',candidate.candidateNumber]">
            <tc-icon [size]="'sm'"
                     [color]="'primary'"
                     [ariaLabel]="'Show candidate in new tab'">
            <i class="fas fa-external-link-alt is-link me-2" title="Show candidate in new tab"></i>
            </tc-icon>
          </a>
          <a [routerLink]="['/candidate',candidate.candidateNumber]">
            <tc-icon [size]="'sm'"
                     [color]="'primary'"
                     [ariaLabel]="'Candidate'">
            <i class="fas fa-user" title="Candidate"></i>
            </tc-icon>
          </a>
          <a *ngIf="isShowStage()" [routerLink]="getCandidateOpportunityLink(candidate)">
            <tc-icon [size]="'sm'"
                     [color]="'primary'"
                     [ariaLabel]="'Case (candidate opportunity)'">
            <i class="fas fa-address-book" title="Case (candidate opportunity)"></i>
            </tc-icon>
          </a>
          <span *ngIf="showSourceDetails" class="d-flex align-items-center gap-1">
            <a target="_blank" [href]="candidate.user.partner.websiteUrl">
              <tc-icon [size]="'sm'"
                       [color]="'primary'"
                       [ariaLabel]="'Partner: ' + candidate.user.partner.name">
              <i class="fas fa-hands-helping" [title]="'Partner: ' + candidate.user.partner.name"></i>
              </tc-icon>
            </a>
            <a *ngIf="candidate.sflink && canAccessSalesforce()" [href]="candidate.sflink" target="_blank">
                  <tc-icon [size]="'sm'"
                           [color]="'primary'"
                           [ariaLabel]="'Show candidate in Salesforce'">
              <i class="fab fa-salesforce" title="Show candidate in Salesforce"></i>
                 </tc-icon>
            </a>
            <a *ngIf="candidate.folderlink && canAccessGoogleDrive()"
               [href]="candidate.folderlink"
               target="_blank">
                  <tc-icon [size]="'sm'"
                           [color]="'primary'"
                           [ariaLabel]="'Show candidate Google Drive folder'">
              <i class="fab fa-google-drive" title="Show candidate's Google Drive folder"></i>
                           </tc-icon>
            </a>
            <a *ngIf="candidate.videolink" [href]="candidate.videolink" target="_blank">
                     <tc-icon [size]="'sm'"
                              [color]="'primary'"
                              [ariaLabel]="'Show candidate\'s one way video'">
              <i class="fas fa-video" title="Show candidate's one way video"></i>
              </tc-icon>
            </a>
            <a *ngIf="candidate.linkedInLink" [href]="candidate.linkedInLink" target="_blank">
                <tc-icon [size]="'sm'"
                         [color]="'primary'"
                         [ariaLabel]="'Show candidate\'s LinkedIn page'">
              <i class="fab fa-linkedin" title="Show candidate's LinkedIn page"></i>
                    </tc-icon>
            </a>
            <app-cv-icon
              [size]="'sm'"
              *ngIf="isCandidateNameViewable()"
              [candidate]="candidate">
            </app-cv-icon>
          </span>
          </div>
        </td>

        <td *ngFor="let field of selectedFields">
          <span>
            {{field.getValue(candidate)}}
          </span>
        </td>
      </tr>

      <!-- no results -->
      <tr *ngIf="!searching && !results?.totalElements">
        <td colspan="42">
          <span class="text-muted">(no matching candidates)</span>
        </td>
      </tr>

      </tbody>

    </tc-table>
  </div>

</div>
<div *ngIf="!results && !searching">
  No results
</div>
<!-- loading -->
<div *ngIf="searching">
  <tc-loading [loading]="searching"></tc-loading>
</div>
