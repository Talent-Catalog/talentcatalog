<!--
  ~ Copyright (c) 2024 Talent Catalog.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under
  ~ the terms of the GNU Affero General Public License as published by the Free
  ~ Software Foundation, either version 3 of the License, or any later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT
  ~ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  ~ FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see https://www.gnu.org/licenses/.
  -->

<tc-loading [loading]="loading"></tc-loading>

<tc-alert type="danger" *ngIf="error">
  <div><strong>{{error}}</strong></div>
</tc-alert>

<div *ngIf="!loading && !loadingError">

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb align-items-center">
      <li class="breadcrumb-item"><a [routerLink]="['/']">Home</a></li>
      <li *ngIf="candidate.user.firstName" class="breadcrumb-item active" aria-current="page">{{candidate.user.firstName}}</li>
      <li *ngIf="!candidate.user.firstName" class="breadcrumb-item active" aria-current="page">{{candidate.candidateNumber}}</li>
      <li *ngIf="isEditable()" class="ms-auto">
        <div  class="input-group">
          <input type="text" class="form-control" id="status" title="{{candidate.candidateMessage}}"
                 value="{{candidate.status | titlecase}}" disabled>
          <button class="btn btn-sm btn-secondary" (click)="editCandidate()"><i class="fas fa-edit fa-sm"></i></button>
        </div>
      </li>
    </ol>

  </nav>

  <div class="d-flex justify-content-between align-items-center">

      <h1>{{candidate.user.firstName}} {{candidate.user.lastName}}
        <span class="small text-muted">
        {{candidate.candidateNumber}}
          <a target="_blank" [routerLink]="['/candidate',candidate.candidateNumber]" class="link-primary">
            <i class="fas fa-external-link-alt is-link" title="Show candidate in new tab"></i>
          </a>
           -
          <a target="_blank" (click)="downloadGeneratedCV()" class="link-info">
              <i class="fas fa-file-download"
                 title="Opens/DLs CV generated from candidate profile"
              ></i>
          </a>
          <a *ngIf="candidate.sflink && canAccessSalesforce()" [href]="candidate.sflink" target="_blank" class="link-info">
            <i class="fab fa-salesforce" title="Show candidate in Salesforce"></i>
          </a>
          <a *ngIf="candidate.folderlink && canAccessGoogleDrive()"
             [href]="candidate.folderlink"
             target="_blank"
             class="link-info">
            <i class="fab fa-google-drive" title="Show candidate's Google Doc folder"></i>
          </a>
          <a *ngIf="candidate.videolink" [href]="candidate.videolink" target="_blank" class="link-info">
            <i class="fas fa-video" title="Show candidate's one way video"></i>
          </a>
          <a *ngIf="candidate.linkedInLink" [href]="candidate.linkedInLink" target="_blank" class="link-info" >
            <i class="fab fa-linkedin" title="Show candidate's linkedIn"></i>
          </a>
          <app-cv-icon
            *ngIf="isCVViewable()"
            [candidate]="candidate">
          </app-cv-icon>
          <a [href]="publicCvUrl()" target="_blank" class="link-info">
            <i class="fas fa-users" title="View candidate's public CV"></i>
          </a>
          <a (click)="createTailoredCv()" class="link-info">
            <i class="fas fa-users-gear"  title="View tailored candidate's public CV"></i>
          </a>
          <app-potential-duplicate-icon
            [candidate]="candidate"
            (refresh)="refreshCandidateProfile()"
          ></app-potential-duplicate-icon>
        </span>
      </h1>


      <div class="col-sm-4">
        <app-candidate-shareable-notes
          [candidate]="candidate"
          [editable] = "isEditable()"
        >
        </app-candidate-shareable-notes>
      </div>

  </div>

  <p class="small text-muted mb-1">Add candidate to a list - you can select from lists you created, global lists
    (like job lists) or lists that you have starred.</p>
  <div class="d-flex align-items-center mb-4">
    <div class="flex-grow-1">
      <ng-select
        [readonly]="!isEditable()"
        [items]="lists"
        [multiple]="true"
        [placeholder]="'Select or Type'"
        [closeOnSelect]="false"
        [clearable]="false"
        [loading]="savingList"
        bindLabel="name"
        [clearSearchOnAdd]="true"
        [(ngModel)]="selectedLists"
        (add)="onItemSelect($event)"
        [compareWith]="compareLists"
        [hideSelected]="true">
        <ng-template ng-header-tmp>
          <span class="text-muted ms-2">Selected: {{selectedLists.length}}</span>
        </ng-template>
        <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">
          <div class="ng-value" *ngFor="let item of items">
            <span class="ng-value-label">
              <a [routerLink]="['/list', item.id]"> {{item.name}} </a>
              <a target="_blank" [routerLink]="['/list', item.id]">
                <i class="fas fa-external-link-alt" title="Open list in new tab"></i>
              </a>
            </span>
            <span class="ng-value-icon right" (click)="onItemDeSelect(item)" aria-hidden="true">×</span>
          </div>
        </ng-template>
      </ng-select>
    </div>

    <button class="btn btn-sm btn-primary ms-2" type="button"
            (click)="onNewList()">+ New List
    </button>
  </div>

  <div class="row">
      <!-- Just have main panel taking up whole screen if they cannot view private data (case notes)-->
      <div class="col-sm-{{canViewPrivateInfo() ? mainPanelColWidth : totalPanelWidth}}">
        <!-- TABS -->
        <tc-tabs [activeTabId]="activeTabId"
                 (tabChanged)="onTabChanged($event)"
        >

          <!-- GENERAL -->
          <tc-tab [id]="'General'">
            <tc-tab-header>
              General
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-general-tab
                [candidate]="candidate"
                [editable]="isEditable()"
                [adminUser]="isAnAdmin()">
              </app-candidate-general-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- EXPERIENCE -->
          <tc-tab [id]="'Experience'">
            <tc-tab-header>
              Experience
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-experience-tab
                [candidate]="candidate"
                [editable]="isEditable()"
                [adminUser]="isAnAdmin()">
              </app-candidate-experience-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Education -->
          <tc-tab [id]="'Education'">
            <tc-tab-header>
              Education
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-education-tab
                [candidate]="candidate"
                [editable]="isEditable()"
                [adminUser]="isAnAdmin()">
              </app-candidate-education-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Additional Info -->
          <tc-tab [id]="'Additional'">
            <tc-tab-header>
              Additional Info
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-additional-info-tab
                [candidate]="candidate"
                [editable]="isEditable()"
                [canViewPrivateInfo]="canViewPrivateInfo()">
              </app-candidate-additional-info-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Mini Intake -->
          <tc-tab [id]="'MiniIntake'" *ngIf="canViewPrivateInfo()">
            <tc-tab-header>
              Mini Intake
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-mini-intake-tab
                [candidate]="candidate">
              </app-candidate-mini-intake-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Intake -->
          <tc-tab [id]="'FullIntake'" *ngIf="canViewPrivateInfo()">
            <tc-tab-header>
              Full Intake
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-intake-tab
                [candidate]="candidate">
              </app-candidate-intake-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Visa eligibility -->
          <tc-tab [id]="'Visa'" *ngIf="canViewPrivateInfo()">
            <tc-tab-header>
              Visa
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-visa-tab
                [candidate]="candidate">
              </app-candidate-visa-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- TASKS -->
          <tc-tab [id]="'Tasks'" *ngIf="canViewPrivateInfo()">
            <tc-tab-header>
              Tasks
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-task-tab
                [candidate]="candidate"
                [editable]="isEditable()">
              </app-candidate-task-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- JOBS -->
          <tc-tab *ngIf="canSeeJobDetails()" [id]="'Jobs'">
            <tc-tab-header>
              Jobs
            </tc-tab-header>
            <tc-tab-content>
              <app-candidate-jobs-tab
                [candidate]="candidate">
              </app-candidate-jobs-tab>
            </tc-tab-content>
          </tc-tab>

          <!-- Chat between source partner and candidate, or the option to create one -->
          <tc-tab [id]="'CandidateProspect'" *ngIf="candidateProspectTabVisible">
            <!-- Tab header -->
            <tc-tab-header>
              Chat With Candidate
            </tc-tab-header>
            <app-chat-read-status *ngIf="candidateChat"
                                  [chats]="[candidateChat]"
            ></app-chat-read-status>
            <!-- Tab content — either the chats or a button to create one with help text -->
            <tc-tab-content>

              <!-- Candidate's notification preferences for non read only users-->
<!--              todo Comment this back in when Opt in/out is being supported-->
<!--              <div *ngIf="!isReadOnlyUser()">-->
<!--                <ng-template #notificationPreferencesTip>-->
<!--                  <div>-->
<!--                    <p>-->
<!--                      You should not normally change this!-->
<!--                    </p>-->
<!--                    <p>-->
<!--                      The candidate decides what chat notifications they would like to see.-->
<!--                      Normally we should respect their decision.-->
<!--                    </p>-->
<!--                  </div>-->
<!--                </ng-template>-->

<!--                <div class="mt-5 mb-4">-->
<!--                  <button class="btn btn-secondary mb-1" (click)="toggleNotificationPreferences()"-->
<!--                          title="">-->
<!--                    {{computeNotificationButtonLabel()}}-->
<!--                  </button>-->
<!--                  <button class="tool-tip-button" [ngbTooltip]="notificationPreferencesTip" triggers="click">-->
<!--                    <i class="fa-regular fa-circle-question fa-xs"></i>-->
<!--                  </button>-->
<!--                </div>-->
<!--              </div>-->

              <div class="mute-btn-align" *ngIf="!isReadOnlyUser()">
                <app-chat-mute-toggle-button
                  [candidate]="candidate"
                  [refreshAfterToggle]="true"
                  (mutedToggled)="onMuteToggled()">
                </app-chat-mute-toggle-button>
              </div>

              <app-view-chat-posts *ngIf="candidateChat; else createChatButton"
                                   [readOnly] = "isReadOnlyUser()"
                                   [chat]="candidateChat">
              </app-view-chat-posts>

              <ng-template #createChatButton>
                <div *ngIf="!isReadOnlyUser()">
                  <div class="text-center mt-5 mb-4">
                    <button class="btn btn-secondary mb-1" (click)="createChat()">
                  <span *ngIf="loadingButton; else elseBlock">
                    <i class="fas fa-spinner fa-spin"></i>
                  </span>
                      <ng-template #elseBlock>
                        <i class="fa-regular fa-comment"></i>
                      </ng-template>
                      Create Chat
                    </button>
                  </div>
                  <div class="text-muted fw-light text-center fs-6">
                    Click the button to create a chat with this candidate.
                    <br><br>
                    They will not see the chat until you have posted, at which point the Chat tab
                    will appear on their candidate portal profile. Candidates are notified via email
                    when new posts are added.
                  </div>
                </div>
              </ng-template>
            </tc-tab-content>
          </tc-tab>

        </tc-tabs>

      </div>
      <div *ngIf="canViewPrivateInfo()" class="col-sm-{{sidePanelColWidth}} admin-panel">
        <div class="w-100">
          <div *ngIf="canToggleSizes()" class="float-end">
            <button class="btn btn-sm btn-outline-secondary" (click)="resizeSidePanel()"><i
              class="fas fa-arrow-{{sidePanelColWidth == 2 ? 'left' : 'right'}}"></i></button>
          </div>
          <app-view-candidate-note
            [candidate]="candidate"
            [editable]="isEditable()"
            [characterLimit]="1000"
            (onResize)="resizeSidePanel()">
          </app-view-candidate-note>
        </div>
      </div>
    </div>
</div>

