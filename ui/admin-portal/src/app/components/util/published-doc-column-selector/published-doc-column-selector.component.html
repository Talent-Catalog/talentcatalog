<!--
  ~ Copyright (c) 2024 Talent Catalog.
  ~
  ~ This program is free software: you can redistribute it and/or modify it under
  ~ the terms of the GNU Affero General Public License as published by the Free
  ~ Software Foundation, either version 3 of the License, or any later version.
  ~
  ~ This program is distributed in the hope that it will be useful, but WITHOUT
  ~ ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  ~ FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  ~ for more details.
  ~
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see https://www.gnu.org/licenses/.
  -->

<tc-modal [heading]="'Select fields to publish'"
          [actionText]="'Publish'"
          (onAction)="submit()"
          [disableAction]="!selectedColumns.length"
          [showCancel]="true"
          [showClose]="true">

  <tc-alert type="danger" *ngIf="error">
    <div><strong>{{error}}</strong></div>
  </tc-alert>

  <div *ngIf="updating">
    <i class="fas fa-spinner fa-spin"></i> Updating...
  </div>

  <div class="container">
    <tc-field>
      <tc-label class="text-center">Available Fields</tc-label>
      <ng-select
        class="tc-select"
        [items]="availableColumns"
        [bindLabel]="'columnDef.header'"
        [multiple]="true"
        [clearable]="false"
        [ngModel]="selectedColumns"
        (add)="addColumn($event)"
        (remove)="removeColumn($event)">
      </ng-select>
    </tc-field>

    <hr>

    <div>
      <p class="text-center h6 mb-1">Selected Fields</p>
      <div class="small mb-3 text-muted text-center">
        Drag away to remove | Click to rename
      </div>
      <div dragula="COLUMNS" [(dragulaModel)]="selectedColumns" class="dragula-container scrollable-columns">
        <div *ngIf="!selectedColumns.length" class="text-center small mt-3">No Columns Selected</div>
        <div *ngFor="let field of selectedColumns; let i = index">
          <div ngbDropdown container="body" #dropdown=ngbDropdown class="d-flex">
            <div id="dropdownForm" class="dragula-field width-100" ngbDropdownToggle>
              <span *ngIf="field.columnProps.header != null; else defaultHeader">{{field.columnProps.header}}</span>
              <ng-template #defaultHeader>
                <span>{{field.columnDef.header}}</span>
              </ng-template>
            </div>
            <div ngbDropdownMenu aria-labelledby="dropdownForm">
              <div class="px-4 py-3">
                <h6 class="py-1">{{field.columnDef.header}}</h6>
                <div class="mb-3">
                  <tc-label [for]="'header'+ i" class="d-block mb-1">
                    New Header Name:
                  </tc-label>

                  <tc-input [type]="'text'"
                            [id]="'header'+ i"
                            [(ngModel)]="field.columnProps.header">
                  </tc-input>
                </div>
                <div *ngIf="!hasFieldName(field)" class="mb-3">
                  <tc-label [for]="'constant'+ i" class="d-block mb-1">
                    New Constant Name:
                  </tc-label>
                  <tc-input [type]="'text'"
                            [id]="'constant'+ i"
                            [(ngModel)]="field.columnProps.constant">
                  </tc-input>
                </div>
                <div class="d-flex justify-content-end gap-2">
                  <tc-button [type]="'outline'"
                             (onClick)="reset(field);
                             dropdown.close()">
                    Reset
                  </tc-button>
                  <tc-button (onClick)="update(field);
                             dropdown.close()">
                    Update
                  </tc-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <tc-button [type]="'outline'" (onClick)="default()">
      Reset to default
    </tc-button>
  </div>

</tc-modal>
